@startuml RamStockAlerts System Flow
!theme plain
skinparam maxMessageSize 150

title RamStockAlerts - End-to-End Flow\n(Real-Time Data → Signal → Auto-Trading → Alerts)

participant "AlpacaStream\n(WebSocket)" as Alpaca
participant "Universe\nBuilder" as Universe
participant "Signal\nValidator" as Validator
participant "Trade\nBlueprint" as Blueprint
participant "Signal\nService" as Service
participant "Alpaca\nTrading" as Trading
participant "Multi-Channel\nNotifications" as Notify
participant "Database" as DB

== Initialization Phase ==
Alpaca -> Universe: Build filtered universe
activate Universe
Universe -> Universe: Filter:\n• Price $10-$80\n• Spread <0.05\n• RelVol >2\n• Float <150M
Universe --> Alpaca: [AAPL, TSLA, ...]
deactivate Universe

Alpaca -> Alpaca: Connect WebSocket\nSubscribe to tickers

== Real-Time Market Data ==
loop Every Trade
    Alpaca -> Alpaca: Update SymbolState:\n• VWAP tracking\n• Tape velocity\n• Spread history
end

== Signal Generation ==
Alpaca -> Validator: CalculateLiquidityScore()
activate Validator
Validator -> Validator: Score components:\n• Spread ≤0.03: +2\n• Bid/Ask ratio ≥3: +3\n• Tape speed ≥5: +2\n• VWAP reclaim: +2
Validator --> Alpaca: score = 9.2
deactivate Validator

Alpaca -> Validator: IsValidSetup()
activate Validator
Validator -> Validator: Check:\n• Anti-spoofing\n• Time windows\n• Operating hours
Validator --> Alpaca: ✅ Valid
deactivate Validator

Alpaca -> Blueprint: Generate(ticker, price, score)
activate Blueprint
Blueprint -> Blueprint: Calculate:\n• Entry = ask price\n• Stop = entry - (spread × 4)\n• Target = entry + (spread × 8)\n• Position = 0.25% risk
Blueprint --> Alpaca: TradeSignal\n(AAPL, $185.50, 178 shares)
deactivate Blueprint

== Save & Auto-Trade ==
Alpaca -> Service: SaveSignalAsync(signal)
activate Service
Service -> Service: Check throttling
Service -> DB: Save signal
activate DB
DB --> Service: signal.Id = 42
deactivate DB

Service -> Trading: PlaceBracketOrderAsync()
activate Trading
Trading -> Trading: Validate:\n• Score ≥8.5?\n• Market open?\n• No duplicate position?
Trading -> Trading: POST bracket order\n(entry + stop + target)
Trading --> Service: orderId = "abc123"
deactivate Trading

Service -> Service: Update signal:\n• OrderId\n• Status = Filled
Service -> DB: Save order info
activate DB
DB --> Service: ✅
deactivate DB

== Multi-Channel Alerts ==
Service -> Notify: SendWithFailoverAsync()
activate Notify
Notify -> Notify: Try Discord
alt Discord Success
    Notify --> Service: ✅ Alert sent
else Discord Failed
    Notify -> Notify: Failover to SMS
    alt SMS Failed
        Notify -> Notify: Failover to Email
    end
end
deactivate Notify

Service --> Alpaca: ✅ Complete
deactivate Service

note over Alpaca, DB
    **Key Features:**
    • Real-time WebSocket streaming
    • Production thresholds (7.5+, time-aware)
    • Auto-trading (disabled by default)
    • 0.25% risk per trade
    • Multi-channel failover alerts
    • Latency target: <500ms
end note

@enduml